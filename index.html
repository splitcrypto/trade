<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SplitCoin (SPLI) â€” Polygon</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7fbf7;
      --card: #ffffff;
      --accent: #1f9d63;
      --muted: #6b7280;
      font-family: Inter, system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: #0f172a; }
    header, footer {
      max-width: 960px; margin: 0 auto; padding: 16px;
      display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;
    }
    .container { max-width: 960px; margin: 20px auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 1fr 340px; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .btn { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-weight: 600; transition: opacity .15s; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px,1fr)); gap: 8px; text-align: center; font-size: 13px; }
    .num { font-weight: 700; font-size: 16px; }
    .muted { color: var(--muted); font-size: 13px; }
    .input-group { display:flex; gap:8px; align-items:center; }
    input[type="number"] { padding:8px; border-radius:8px; border:1px solid #ddd; width:100%; }
    .about { max-width: 960px; margin:20px auto; padding:16px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); line-height:1.5; }
    .about h3 { margin-top:0; color:var(--accent); }
    .about ul { padding-left:20px; }
    @media(max-width:800px){ .container{ grid-template-columns:1fr } }
  </style>
</head>
<body>

<header>
  <h2>SplitCoin (SPLI) â€” Polygon</h2>
  <div>
    <button id="connectMetaMask" class="btn">ðŸ¦Š MetaMask</button>
    <button id="connectWC" class="btn">ðŸ”— WalletConnect</button>
  </div>
</header>

<div class="container">
  <div>
    <div class="card">
      <div><strong>Address:</strong> <span id="address">â€”</span></div>
      <div><strong>Network:</strong> <span id="network">â€”</span></div>
      <hr>
      <div class="stats">
        <div><div class="num" id="yourBalance">â€”</div><div>Your SPLI</div></div>
        <div><div class="num" id="totalSupply">â€”</div><div>Total Supply</div></div>
        <div><div class="num" id="vaultBalance">â€”</div><div>Vault</div></div>
        <div><div class="num" id="circulating">â€”</div><div>Circulating</div></div>
        <div><div class="num" id="canSell">â€”</div><div>Can Sell?</div></div>
      </div>
      <div style="margin-top:8px"><strong>Price:</strong> <span id="currentPrice">â€”</span></div>
    </div>

    <div class="card">
      <h3>Buy SPLI</h3>
      <div class="input-group" style="margin:8px 0;">
        <input id="buyAmount" type="number" placeholder="Amount" min="0" step="any" />
        <div style="font-weight:600">POL (MATIC)</div>
      </div>
      <button id="buyBtn" class="btn">Buy</button>
    </div>
  </div>

  <div>
    <div class="card">
      <h3>Sell SPLI</h3>
      <button id="sellBtn" class="btn">Sell All</button>
    </div>

    <div class="card" id="devMenu" style="display:none">
      <h3>Developer Menu</h3>
      <button class="btn" id="enableTradingBtn">Enable Trading</button>
      <button class="btn" id="pauseBtn">Pause</button>
      <button class="btn" id="unpauseBtn">Unpause</button>
      <button class="btn" id="withdrawAllBtn">Withdraw All POL</button>
    </div>
  </div>
</div>

<div class="card about">
  <h2>About SplitCoin (SPLI)</h2>
  <p>Your description text remains unchanged.</p>
</div>

<footer class="muted" style="text-align:center; padding:18px 0;">
  Built for SplitCoin â€” Polygon Network
</footer>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.1/dist/index.min.js"></script>

<script>
const CONTRACT_ADDRESS = "0x6E58bb9D89175c9d2a648f6ED7BF4ed9Bd45E8a9";

const ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function totalSupply() view returns (uint256)",
  "function vault() view returns (address)",
  "function currentPrice() view returns (uint256)",
  "function totalPurchases() view returns (uint256)",
  "function purchaseIndex(address) view returns (uint256)",
  "function buyTokens() payable",
  "function sellTokens(uint256)",
  "function owner() view returns(address)",
  "function enableTrading(bool)",
  "function pause()",
  "function unpause()",
  "function withdrawAllPOL()",
  "event TokensPurchased(address,uint256,uint256,uint256)",
  "event TokensSold(address,uint256,uint256,uint256)"
];

const WC_PROJECT_ID = "a38499ec874228017b4bf3f6d342dcb4";

let provider = null, signer = null, contract = null;

async function connectMetaMask() {
  if (!window.ethereum) return alert("Please install MetaMask!");
  await window.ethereum.request({ method: "eth_requestAccounts" });
  provider = new ethers.BrowserProvider(window.ethereum);
  await setup();
}

async function connectWalletConnect() {
  const wcProvider = await window.WalletConnectEthereumProvider.init({
    projectId: WC_PROJECT_ID,
    chains: [137],
    optionalChains: [137],
    showQrModal: true,
    rpcMap: { 137: "https://polygon-rpc.com" }
  });

  await wcProvider.enable();
  provider = new ethers.BrowserProvider(wcProvider);
  await setup();
}

async function setup() {
  signer = await provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  const addr = (await signer.getAddress()).toLowerCase();
  document.getElementById("address").textContent = addr.slice(0,6)+"..."+addr.slice(-4);

  document.getElementById("network").textContent = "Polygon (chain 137)";
  if ((await provider.getNetwork()).chainId !== 137) alert("Switch to Polygon!");

  if ((await contract.owner()).toLowerCase() === addr) document.getElementById("devMenu").style.display = "block";

  await refresh();
  contract.on("TokensPurchased", refresh);
  contract.on("TokensSold", refresh);
}

async function refresh() {
  const addr = await signer.getAddress();
  const vaultAddr = await contract.vault();
  const [bal, supply, vaultBal, price, total, idx] = await Promise.all([
    contract.balanceOf(addr),
    contract.totalSupply(),
    contract.balanceOf(vaultAddr),
    contract.currentPrice(),
    contract.totalPurchases(),
    contract.purchaseIndex(addr)
  ]);

  const fmt = (x) => Number(ethers.formatUnits(x,18)).toFixed(4);

  document.getElementById("yourBalance").textContent = fmt(bal);
  document.getElementById("totalSupply").textContent = fmt(supply);
  document.getElementById("vaultBalance").textContent = fmt(vaultBal);
  document.getElementById("circulating").textContent = fmt(supply - vaultBal);
  document.getElementById("currentPrice").textContent = fmt(price) + " MATIC";
  document.getElementById("canSell").textContent = total > idx ? "âœ… Yes" : "âŒ No";
}

document.getElementById("connectMetaMask").onclick = connectMetaMask;
document.getElementById("connectWC").onclick = connectWalletConnect;

document.getElementById("buyBtn").onclick = async () => {
  const val = document.getElementById("buyAmount").value;
  if (!val || val <= 0) return alert("Enter an amount");
  const tx = await contract.buyTokens({ value: ethers.parseUnits(String(val), 18) });
  await tx.wait();
  refresh();
};

document.getElementById("sellBtn").onclick = async () => {
  const amt = await contract.balanceOf(await signer.getAddress());
  if (amt == 0n) return alert("No SPLI to sell");
  const tx = await contract.sellTokens(amt);
  await tx.wait();
  refresh();
};

document.getElementById("enableTradingBtn").onclick = async () => { await (await contract.enableTrading(true)).wait(); refresh(); };
document.getElementById("pauseBtn").onclick = async () => { await (await contract.pause()).wait(); refresh(); };
document.getElementById("unpauseBtn").onclick = async () => { await (await contract.unpause()).wait(); refresh(); };
document.getElementById("withdrawAllBtn").onclick = async () => { await (await contract.withdrawAllPOL()).wait(); refresh(); };

setInterval(() => { if (contract) refresh(); }, 15000);
</script>
</body>
</html>
