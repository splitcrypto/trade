<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SplitCoin (SPLI) â€” Polygon</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7fbf7;
      --card: #ffffff;
      --accent: #1f9d63;
      --muted: #6b7280;
      font-family: Inter, system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: #0f172a; }
    header, footer {
      max-width: 960px; margin: 0 auto; padding: 16px;
      display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;
    }
    .container { max-width: 960px; margin: 20px auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 1fr 340px; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .btn { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-weight: 600; transition: opacity .15s; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px,1fr)); gap: 8px; text-align: center; font-size: 13px; }
    .num { font-weight: 700; font-size: 16px; }
    .muted { color: var(--muted); font-size: 13px; }
    .input-group { display:flex; gap:8px; align-items:center; }
    input[type="number"] { padding:8px; border-radius:8px; border:1px solid #ddd; width:100%; }
    .about { max-width: 960px; margin:20px auto; padding:16px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); line-height:1.5; }
    .about h3 { margin-top:0; color:var(--accent); }
    .about ul { padding-left:20px; }
    @media(max-width:800px){ .container{ grid-template-columns:1fr } }
  </style>
</head>
<body>

<header>
  <h2>SplitCoin (SPLI) â€” Polygon</h2>
  <div>
    <button id="connectMetaMask" class="btn">ðŸ¦Š MetaMask</button>
    <button id="connectWC" class="btn">ðŸ”— WalletConnect</button>
  </div>
</header>

<div class="container">
  <div>
    <div class="card">
      <div><strong>Address:</strong> <span id="address">â€”</span></div>
      <div><strong>Network:</strong> <span id="network">â€”</span></div>
      <hr>
      <div class="stats">
        <div><div class="num" id="yourBalance">â€”</div><div>Your SPLI</div></div>
        <div><div class="num" id="totalSupply">â€”</div><div>Total Supply</div></div>
        <div><div class="num" id="vaultBalance">â€”</div><div>Vault</div></div>
        <div><div class="num" id="circulating">â€”</div><div>Circulating</div></div>
        <div><div class="num" id="canSell">â€”</div><div>Can Sell?</div></div>
      </div>
      <div style="margin-top:8px"><strong>Price:</strong> <span id="currentPrice">â€”</span></div>
    </div>

    <div class="card">
      <h3>Buy SPLI</h3>
      <div class="input-group" style="margin:8px 0;">
        <input id="buyAmount" type="number" placeholder="Amount" min="0" step="any" />
        <div style="font-weight:600">POL (MATIC)</div>
      </div>
      <button id="buyBtn" class="btn">Buy</button>
    </div>
  </div>

  <div>
    <div class="card">
      <h3>Sell SPLI</h3>
      <button id="sellBtn" class="btn">Sell All</button>
    </div>

    <div class="card" id="devMenu" style="display:none">
      <h3>Developer Menu</h3>
      <button class="btn" id="enableTradingBtn">Enable Trading</button>
      <button class="btn" id="pauseBtn">Pause</button>
      <button class="btn" id="unpauseBtn">Unpause</button>
      <button class="btn" id="withdrawAllBtn">Withdraw All POL</button>
    </div>
  </div>
</div>

<div class="card about">
  <h2>About SplitCoin (SPLI)</h2>

  <p><strong>Our Vision:</strong> When we make money, you make money too! SplitCoin brings people together to profit from quick, strategic moves. Each purchase instantly locks in gains for the buyer, creating opportunities for fast cashouts while everyone participates in the action.</p>

  <p><strong>Mechanics:</strong> SplitCoin (SPLI) is a novel approach to asset trading. Typically, stocks or crypto are held for long periods while value slowly increases. With SPLI, buying a token instantly locks in a 25% profit â€” your position will never be worth less, but will also never be worth more. The vault burns an equal amount of tokens with every purchase to maintain supply control and stabilize price. The goal becomes to cash out as quickly as possible, which can happen as soon as another purchase is made by someone else. Once you sell, you can buy in again, aiming for the next fast cashout. This model rewards speed, strategy, and participation in the community-driven liquidity cycle.</p>

  <p><strong>Rules of Participation:</strong></p>
  <ul>
    <li>Buy SPLI to lock in a guaranteed 25% gain instantly.</li>
    <li>No trading between holders â€” token is traded to and from the vault only (exceptions can be made).</li>
    <li>Full exits only: sell your tokens after someone else buys to realize your profit.</li>
    <li>Single entrance â€” must cash out before purchasing more tokens.</li>
    <li>Liquidity guard ensures no purchases allowed with a payout over 1/3 the size of the vault liquidity.</li>
    <li>After selling, you can buy in again for the next fast-turn opportunity.</li>
    <li>Vault liquidity and token supply control the flow â€” every participantâ€™s move matters, with vault burns ensuring price stability.</li>
    <li>Owner-only functions (enable trading, pause/unpause, liquidity control) ensure a fair and stable environment, additional liquidity may be provided by owner as warranted.</li>
  </ul>

  <p>Jump in, time your buys and sells, and see how quickly you can turn a profit. SPLI makes trading fast, fair, and community-driven â€” get ready to be part of the next big step in crypto evolution!</p>
</div>

<footer class="muted" style="text-align:center; padding:18px 0;">
  Built for SplitCoin â€” Polygon Network
</footer>

<!-- dependencies: ethers (UMD) + WalletConnect v2 UMD -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.1/dist/index.min.js"></script>

<script>
/* ------------------------
   Configuration
   ------------------------ */
const CONTRACT_ADDRESS = "0x7F065737A1c975a5e037355Bdf33f5E58E4d15B0";
const ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function totalSupply() view returns (uint256)",
  "function vault() view returns (address)",
  "function currentPrice() view returns (uint256)",
  "function totalPurchases() view returns (uint256)",
  "function purchaseIndex(address) view returns (uint256)",
  "function buyTokens() payable",
  "function sellTokens(uint256)",
  "function owner() view returns(address)",
  "function enableTrading(bool)",
  "function pause()",
  "function unpause()",
  "function withdrawAllPOL()",
  "event TokensPurchased(address,uint256,uint256,uint256)",
  "event TokensSold(address,uint256,uint256,uint256)"
];

// WalletConnect demo projectId (replace with your own if/when desired)
const WC_PROJECT_ID = "d7cb9cfc2b9b6d7f731a6f9b7c8b32b1"; // public demo id

/* ------------------------
   App state
   ------------------------ */
let provider = null;
let signer = null;
let contract = null;
let connectedWalletType = null; // "metamask" | "walletconnect"

/* ------------------------
   Helpers
   ------------------------ */
function setConnectedUI(type, shortAddr) {
  connectedWalletType = type;
  const metaBtn = document.getElementById("connectMetaMask");
  const wcBtn = document.getElementById("connectWC");
  if (type === "metamask") {
    metaBtn.textContent = "MetaMask âœ…";
    metaBtn.disabled = true;
    wcBtn.disabled = false;
  } else if (type === "walletconnect") {
    wcBtn.textContent = "WalletConnect âœ…";
    wcBtn.disabled = true;
    metaBtn.disabled = false;
  }
  document.getElementById("address").textContent = shortAddr;
}

/* ------------------------
   Connectors
   ------------------------ */
async function connectMetaMask() {
  try {
    if (!window.ethereum) return alert("Please install MetaMask!");
    await window.ethereum.request({ method: "eth_requestAccounts" });
    provider = new ethers.BrowserProvider(window.ethereum);
    await initializeAfterProvider("metamask");
  } catch (err) {
    console.error("MetaMask connect error:", err);
    alert("MetaMask connection failed");
  }
}

async function connectWalletConnect() {
  try {
    // UMD exposes WalletConnectEthereumProvider on window
    const wcProvider = await window.WalletConnectEthereumProvider.init({
      projectId: WC_PROJECT_ID,
      chains: [137],
      showQrModal: true,
      rpc: { 137: "https://polygon-rpc.com/" }
    });

    // enable() triggers QR modal / mobile deep link
    await wcProvider.enable();

    provider = new ethers.BrowserProvider(wcProvider);
    await initializeAfterProvider("walletconnect");

    // handle disconnects from WalletConnect session
    wcProvider.on("disconnect", (code, reason) => {
      console.log("WC disconnect", code, reason);
      // reset UI
      document.getElementById("connectWC").textContent = "ðŸ”— WalletConnect";
      document.getElementById("connectWC").disabled = false;
      document.getElementById("connectMetaMask").disabled = false;
      document.getElementById("address").textContent = "â€”";
      connectedWalletType = null;
    });
  } catch (err) {
    console.error("WalletConnect error:", err);
    alert("WalletConnect failed to connect");
  }
}

/* ------------------------
   Initialize after provider
   ------------------------ */
async function initializeAfterProvider(type) {
  signer = await provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  const addr = (await signer.getAddress()).toLowerCase();
  const short = addr.slice(0,6) + "..." + addr.slice(-4);
  setConnectedUI(type, short);

  const network = await provider.getNetwork();
  document.getElementById("network").textContent = network.name + " (chain " + network.chainId + ")";

  // show dev menu if owner
  try {
    const ownerAddr = (await contract.owner()).toLowerCase();
    if (addr === ownerAddr) document.getElementById("devMenu").style.display = "block";
  } catch(e){ console.warn("owner check failed", e); }

  // start live update and event listeners
  await fetchData();

  // update on on-chain TokensPurchased events to keep sell eligibility live
  contract.on("TokensPurchased", async (...args) => {
    // args: buyer, amountSpent, tokensReceived, newPrice, event
    try { await fetchData(); } catch(e){ console.error(e); }
  });

  contract.on("TokensSold", async (...args) => {
    try { await fetchData(); } catch(e){ console.error(e); }
  });
}

/* ------------------------
   Fetch data and UI update
   ------------------------ */
async function fetchData() {
  if (!contract || !signer) return;
  try {
    const addr = await signer.getAddress();
    const [b, y, v, p, totalPurchases] = await Promise.all([
      contract.balanceOf(addr),
      contract.totalSupply(),
      contract.balanceOf(await contract.vault()),
      contract.currentPrice(),
      contract.totalPurchases()
    ]);

    const purchaseIndex = await contract.purchaseIndex(addr);
    const canSellFlag = totalPurchases > purchaseIndex;

    document.getElementById("yourBalance").textContent = Number(ethers.formatUnits(b,18)).toFixed(4);
    document.getElementById("totalSupply").textContent = Number(ethers.formatUnits(y,18)).toFixed(2);
    document.getElementById("vaultBalance").textContent = Number(ethers.formatUnits(v,18)).toFixed(2);
    document.getElementById("circulating").textContent = (Number(ethers.formatUnits(y-v,18))).toFixed(2);
    document.getElementById("currentPrice").textContent = Number(ethers.formatUnits(p,18)) + " MATIC";
    document.getElementById("canSell").textContent = canSellFlag ? "âœ… Yes" : "âŒ No";
  } catch (err) {
    console.error("fetchData error", err);
  }
}

/* ------------------------
   Actions / Buttons
   ------------------------ */
document.getElementById("connectMetaMask").onclick = connectMetaMask;
document.getElementById("connectWC").onclick = connectWalletConnect;

document.getElementById("buyBtn").onclick = async () => {
  if (!contract || !signer) return alert("Connect a wallet first");
  const val = Number(document.getElementById("buyAmount").value);
  if (!val || val <= 0) return alert("Enter POL (MATIC) amount");
  try {
    const tx = await contract.buyTokens({ value: ethers.parseUnits(String(val), 18) });
    await tx.wait();
    await fetchData();
  } catch (err) {
    console.error("buy error", err);
    alert("Buy failed: " + (err?.message || err));
  }
};

document.getElementById("sellBtn").onclick = async () => {
  if (!contract || !signer) return alert("Connect a wallet first");
  try {
    const addr = await signer.getAddress();
    const amt = await contract.balanceOf(addr);
    if (amt == 0n) return alert("You have no SPLI to sell");
    const tx = await contract.sellTokens(amt);
    await tx.wait();
    await fetchData();
  } catch (err) {
    console.error("sell error", err);
    alert("Sell failed: " + (err?.message || err));
  }
};

// Dev menu actions
document.getElementById("enableTradingBtn").onclick = async () => { await (await contract.enableTrading(true)).wait(); alert("Trading enabled"); };
document.getElementById("pauseBtn").onclick = async () => { await (await contract.pause()).wait(); alert("Paused"); };
document.getElementById("unpauseBtn").onclick = async () => { await (await contract.unpause()).wait(); alert("Unpaused"); };
document.getElementById("withdrawAllBtn").onclick = async () => { await (await contract.withdrawAllPOL()).wait(); alert("Withdrawn"); };

/* ------------------------
   Live refresh every 15s
   ------------------------ */
setInterval(() => { if (contract && signer) fetchData(); }, 15000);
</script>
</body>
</html>
